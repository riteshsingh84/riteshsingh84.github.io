name: Collect Subscribers

on:
  repository_dispatch:
    types: [collect_email]

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate payload
        run: |
          if [ -z "${{ github.event.client_payload.email }}" ]; then
            echo "No email provided in client_payload";
            exit 1;
          fi

      - name: Append subscriber
        env:
          EMAIL: ${{ github.event.client_payload.email }}
        run: |
          FILE=subscribers.json
          ts=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          # ensure file exists
          if [ ! -f "$FILE" ]; then echo '[]' > $FILE; fi
          # avoid duplicates
          exists=$(jq --arg email "$EMAIL" 'map(.email) | index($email) | tostring' $FILE)
          if [ "$exists" != "null" ]; then
            echo "Email already subscribed: $EMAIL";
          else
            tmp=$(mktemp)
            jq --arg email "$EMAIL" --arg ts "$ts" '. + [{email: $email, ts: $ts}]' $FILE > "$tmp" && mv "$tmp" $FILE
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add $FILE
            git commit -m "Add subscriber $EMAIL [skip ci]" || echo "No changes to commit"
            git push origin HEAD:${{ github.ref }} || git push
            echo "Added subscriber: $EMAIL"
          fi
